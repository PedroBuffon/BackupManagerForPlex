# Plex Backup Manager - CI/CD Pipeline
# This workflow builds and tests the Plex Backup Manager Windows Forms application
# Built on .NET 9.0 with Windows Forms support

name: Plex Backup Manager Build

on:
  push:
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0.0, v20.15.10
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

permissions:
  contents: write

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest

    steps:
    - name: 'ğŸ“„ Checkout'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install .NET 9.0
    - name: 'ğŸ”§ Setup .NET'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    # Restore dependencies
    - name: 'ğŸ“¦ Restore dependencies'
      run: dotnet restore PlexBackup.sln

    # Build the application
    - name: 'ğŸ”¨ Build'
      run: dotnet build PlexBackup.sln --configuration Release --no-restore

    # Test the application (if tests exist)
    - name: 'ğŸ§ª Test'
      run: dotnet test PlexBackup.sln --configuration Release --no-build --verbosity normal
      continue-on-error: true

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: 'ğŸ“„ Checkout'
      uses: actions/checkout@v4

    - name: 'ï¿½ Debug Info'
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Ref Name: ${{ github.ref_name }}"
        echo "Tag Check: ${{ startsWith(github.ref, 'refs/tags/') }}"

    - name: 'ï¿½ğŸ”§ Setup .NET'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: 'ğŸ“¦ Package windows x64'
      run: |
        dotnet publish PlexBackup.csproj -r win-x64 -c Release -o bin/win-x64 --self-contained false
        Copy-Item "config.json.example" "bin/win-x64/" -ErrorAction SilentlyContinue
        Copy-Item "README.md" "bin/win-x64/" -ErrorAction SilentlyContinue
        Copy-Item "ROLLBACK.md" "bin/win-x64/" -ErrorAction SilentlyContinue
        Compress-Archive -Path "bin/win-x64/*" -DestinationPath "PlexBackup-win-x64.zip"

    - name: 'ğŸ“¦ Package windows x86'
      run: |
        dotnet publish PlexBackup.csproj -r win-x86 -c Release -o bin/win-x86 --self-contained false
        Copy-Item "config.json.example" "bin/win-x86/" -ErrorAction SilentlyContinue
        Copy-Item "README.md" "bin/win-x86/" -ErrorAction SilentlyContinue
        Copy-Item "ROLLBACK.md" "bin/win-x86/" -ErrorAction SilentlyContinue
        Compress-Archive -Path "bin/win-x86/*" -DestinationPath "PlexBackup-win-x86.zip"

    - name: 'ğŸ“¦ Package windows arm64'
      run: |
        dotnet publish PlexBackup.csproj -r win-arm64 -c Release -o bin/win-arm64 --self-contained false
        Copy-Item "config.json.example" "bin/win-arm64/" -ErrorAction SilentlyContinue
        Copy-Item "README.md" "bin/win-arm64/" -ErrorAction SilentlyContinue
        Copy-Item "ROLLBACK.md" "bin/win-arm64/" -ErrorAction SilentlyContinue
        Compress-Archive -Path "bin/win-arm64/*" -DestinationPath "PlexBackup-win-arm64.zip"

    - name: 'ğŸš€ Create Release'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Plex Backup Manager ${{ github.ref_name }}
        body: |
          ## Plex Backup Manager Release ${{ github.ref_name }}
          
          ### ğŸ†• New Features:
          - **Rollback System**: Automatic rollback when backup fails
          - **Enhanced UI**: Improved settings and configuration options
          - **System Tray**: Minimize to system tray functionality
          - **JSON Configuration**: Modern configuration format
          
          ### ğŸ”§ Improvements:
          - Better error handling and logging
          - Comprehensive backup validation
          - Enhanced file and registry backup processes
          - Automatic cleanup of old backups
          
          ### ğŸ“¦ Available Packages:
          - **win-x64**: For 64-bit Windows systems (Recommended)
          - **win-x86**: For 32-bit Windows systems
          - **win-arm64**: For ARM64 Windows systems
          
          ### ğŸ“‹ Installation:
          1. Download the appropriate ZIP file for your system architecture
          2. Extract to your desired location
          3. Run `PlexBackup.exe`
          4. Configure your backup settings
          
          ### âš™ï¸ System Requirements:
          - Windows 10/11 or Windows Server 2019+
          - .NET 9.0 Runtime (will be prompted to install if missing)
          - Plex Media Server installed
          
          ### ğŸ†˜ Support:
          - Check `README.md` for basic usage instructions
          - Check `ROLLBACK.md` for rollback feature documentation
          - Report issues on GitHub
        files: |
          PlexBackup-win-x64.zip
          PlexBackup-win-x86.zip
          PlexBackup-win-arm64.zip
        draft: false
        prerelease: false
